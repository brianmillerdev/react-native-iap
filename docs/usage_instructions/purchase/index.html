<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.0">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="React Native IAP Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="React Native IAP Blog Atom Feed"><title data-react-helmet="true">Making a purchase | React Native IAP</title><meta data-react-helmet="true" property="og:url" content="https://react-native-iap.dooboolab.com/docs/usage_instructions/purchase"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Making a purchase | React Native IAP"><meta data-react-helmet="true" name="description" content="Purchase Flow Redesign"><meta data-react-helmet="true" property="og:description" content="Purchase Flow Redesign"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://react-native-iap.dooboolab.com/docs/usage_instructions/purchase"><link data-react-helmet="true" rel="alternate" href="https://react-native-iap.dooboolab.com/docs/usage_instructions/purchase" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://react-native-iap.dooboolab.com/docs/usage_instructions/purchase" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.36aa7f87.css">
<link rel="preload" href="/assets/js/runtime~main.7894085f.js" as="script">
<link rel="preload" href="/assets/js/main.a5ca3dc9.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="react ntaive iap" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="react ntaive iap" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">React Native IAP</strong></a><a class="navbar__item navbar__link navbar__link--active" href="/docs/intro">Documentation</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/dooboolab/react-native-iap" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle displayOnlyInLargeViewport_GrZ2 react-toggle--disabled" role="button" tabindex="-1"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_71bT">üåú</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">üåû</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/logo.png" alt="react ntaive iap" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/logo.png" alt="react ntaive iap" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">React Native IAP</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link navbar__link--active" href="/docs/intro">Documentation</a></li><li class="menu__list-item"><a href="https://github.com/dooboolab/react-native-iap" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper docs-wrapper doc-page"><div class="docPage_31aa"><div class="docSidebarContainer_3Kbt" role="complementary"><div class="sidebar_15mo"><div class="menu menu--responsive thin-scrollbar menu_Bmed"><button aria-label="Open menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_fgN0" width="24" height="24" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/intro">React Native IAP</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/installing">Installing</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Usage instructions</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/usage_instructions/connection_lifecycle">Lifecycle</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/usage_instructions/retrieve_available">Retrieving available items</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/usage_instructions/purchase">Making a purchase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/usage_instructions/restoring_purchases">Restoring purchases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/usage_instructions/receipt_validation">Validating receipts</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/usage_instructions/using_hooks">Using hooks</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">API Reference</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api_reference/available_purchase">AvailablePurchase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api_reference/methods">Available Methods</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/api_reference/product">Product</a></li></ul></li><li class="menu__list-item"><a class="menu__link" href="/docs/manual_install">Manual installation</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/amazon">Amazon IAP Support</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/faq">Frequently Asked Questions</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/support_us">Supporting react-native-iap</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/troubleshooting">Troubleshooting</a></li></ul></div></div></div><main class="docMainContainer_3ufF"><div class="container padding-vert--lg docItemWrapper_3FMP"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><header><h1 class="docTitle_3a4h">Making a purchase</h1></header><div class="markdown"><blockquote><p>‚ö†Ô∏è <strong>Purchase Flow Redesign</strong> ‚ö†Ô∏è</p><p>The <code>purchase</code> flow has been updated as a result of the findings in issue <a href="https://github.com/dooboolab/react-native-iap/issues/307">#307</a>.
The resulting flow has been redesign to not rely on <code>Promise</code> or <code>Callback</code>.</p><p>Below are some of the specific reasons for the redesign:</p><ol><li>There may be more than one response when requesting a payment.</li><li>Purchases are inter-session <code>asynchronuous</code> meaning requests that are made may take several hours to complete and continue to exist even after the app has been closed or crashed.</li><li>The purchase may be pending and hard to track what has been done (<a href="https://github.com/dooboolab/react-native-iap/issues/307">example</a>.</li><li>The Billing Flow is an <code>event</code> pattern rather than a <code>callback</code> pattern.</li></ol></blockquote><p>Once you have called <code>getProducts()</code>, and have a valid response, you can call <code>requestPurchase()</code>. Subscribable products can be purchased just like consumable products and users can cancel subscriptions by using the iOS System Settings.</p><p>Before you request any purchase, you should set <code>purchaseUpdatedListener</code> from <code>react-native-iap</code>. It is recommended that you start listening to updates as soon as your application launches. And don&#x27;t forget that even at launch you may receive successful purchases that either completed while your app was closed or that failed to be finished, consumed or acknowledged due to network errors or bugs.</p><pre><code class="language-javascript">import RNIap, {
  purchaseErrorListener,
  purchaseUpdatedListener,
  type ProductPurchase,
  type PurchaseError
} from &#x27;react-native-iap&#x27;;

class RootComponent extends Component&lt;*&gt; {
  purchaseUpdateSubscription = null
  purchaseErrorSubscription = null

  componentDidMount() {
    RNIap.initConnection().then(() =&gt; {
      // we make sure that &quot;ghost&quot; pending payment are removed
      // (ghost = failed pending payment that are still marked as pending in Google&#x27;s native Vending module cache)
      RNIap.flushFailedPurchasesCachedAsPendingAndroid().catch(() =&gt; {
        // exception can happen here if:
        // - there are pending purchases that are still pending (we can&#x27;t consume a pending purchase)
        // in any case, you might not want to do anything special with the error
      }).then(() =&gt; {
        this.purchaseUpdateSubscription = purchaseUpdatedListener((purchase: InAppPurchase | SubscriptionPurchase | ProductPurchase ) =&gt; {
          console.log(&#x27;purchaseUpdatedListener&#x27;, purchase);
          const receipt = purchase.transactionReceipt;
          if (receipt) {
            yourAPI.deliverOrDownloadFancyInAppPurchase(purchase.transactionReceipt)
            .then( async (deliveryResult) =&gt; {
              if (isSuccess(deliveryResult)) {
                // Tell the store that you have delivered what has been paid for.
                // Failure to do this will result in the purchase being refunded on Android and
                // the purchase event will reappear on every relaunch of the app until you succeed
                // in doing the below. It will also be impossible for the user to purchase consumables
                // again until you do this.
                await RNIap.finishTransaction(purchase);

                // From react-native-iap@4.1.0 you can simplify above `method`. Try to wrap the statement with `try` and `catch` to also grab the `error` message.
                // If consumable (can be purchased again)
                await RNIap.finishTransaction(purchase, true);
                // If not consumable
                await RNIap.finishTransaction(purchase, false);
              } else {
                // Retry / conclude the purchase is fraudulent, etc...
              }
            });
          }
        });

        this.purchaseErrorSubscription = purchaseErrorListener((error: PurchaseError) =&gt; {
          console.warn(&#x27;purchaseErrorListener&#x27;, error);
        });
      })
    })
  }

  componentWillUnmount() {
    if (this.purchaseUpdateSubscription) {
      this.purchaseUpdateSubscription.remove();
      this.purchaseUpdateSubscription = null;
    }
    if (this.purchaseErrorSubscription) {
      this.purchaseErrorSubscription.remove();
      this.purchaseErrorSubscription = null;
    }
  }
}
</code></pre><p>Then define the method like below and call it when user press the button.</p><pre><code class="language-javascript">  requestPurchase = async (sku: string) =&gt; {
    try {
      await RNIap.requestPurchase(sku, false);
    } catch (err) {
      console.warn(err.code, err.message);
    }
  }

  requestSubscription = async (sku: string) =&gt; {
    try {
      await RNIap.requestSubscription(sku);
    } catch (err) {
      console.warn(err.code, err.message);
    }
  }

  render() {
    ...
      onPress={() =&gt; this.requestPurchase(product.productId)}
    ...
  }
</code></pre><h2 id="new-purchase-flow">New Purchase Flow</h2><p><img alt="purchase-flow-sequence" src="/assets/images/react-native-iapv3-8467b005f57bac1f11896c06e15577aa.svg"></p><p>Most likely, you&#x27;ll want to handle the ‚Äústore kit flow‚Äù[<sup>[2]</sup>][apple-store-kit-flow],
which happens when a user successfully pays after solving a problem with his or her account ‚Äì for example, when the credit card information has expired.</p><p>For above reason, we decided to remove <del><code>buyProduct</code></del> and use <code>requestPurchase</code> instead which doesn&#x27;t rely on promise function. The <code>purchaseUpdatedListener</code> will receive the success purchase and <code>purchaseErrorListener</code> will receive all the failure result that occurred during the purchase attempt.</p><h2 id="finishing-a-purchase">Finishing a Purchase</h2><p>Purchases will keep being emitted to your <code>purchaseUpdatedListener</code> on every app relaunch until you finish the purchase.</p><p>All purchases should be consumed by calling  <code>finishTransaction()</code>. </p><ul><li>For consumables: Once an item is consumed, it will be removed from <code>getAvailablePurchases()</code> so it is up to you to record the purchase into your database before calling  <code>finishTransaction()</code>.</li><li>For non-consumable purchases need to be acknowledged on Android, or they will be automatically refunded after a few days. This method acknowledges a purchase when you have delivered it to your user.</li><li>On iOS non-consumable purchases are finished automatically but this will change in the future so it is recommended that you prepare by simply calling this method on non-consumables as well.</li><li>It works for both platforms. Equal to finishTransaction for iOS + consumePurchase and acknowledgePurchase for Android.</li></ul></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/dooboolab/react-native-iap/edit/master/docs/docs/usage_instructions/purchase.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" role="img" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-label="Edit page"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/usage_instructions/retrieve_available"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">¬´ Retrieving available items</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/usage_instructions/restoring_purchases"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Restoring purchases ¬ª</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#new-purchase-flow" class="table-of-contents__link">New Purchase Flow</a></li><li><a href="#finishing-a-purchase" class="table-of-contents__link">Finishing a Purchase</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">GitHub</h4><ul class="footer__items"><li class="footer__item"><a href="https://github.com/dooboolab/react-native-iap/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues</a></li><li class="footer__item"><a href="https://github.com/dooboolab/react-native-iap/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions</a></li><li class="footer__item"><a href="https://github.com/dooboolab/react-native-iap/pulls" target="_blank" rel="noopener noreferrer" class="footer__link-item">Pull requests</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">This is an Open Source project using the MIT license built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.7894085f.js"></script>
<script src="/assets/js/main.a5ca3dc9.js"></script>
</body>
</html>